
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="My Blog Site">
      
      
        <meta name="author" content="Tony Lofreso">
      
      
        <link rel="canonical" href="https://tlofreso.github.io/2024/05/15/advanced-rag/">
      
      
        <link rel="prev" href="../../../03/15/my-plans-for-the-2024-solar-eclipse/">
      
      
        <link rel="next" href="../../../08/19/i-napoleon/">
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12+insiders-4.53.16">
    
    
      
        <title>Advanced RAG - Tony's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.ff49f96f.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        
        <link rel="stylesheet" href="../../../../assets/external/fonts.googleapis.com/css.49ea35f2.css">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#advanced-rag" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Tony&#39;s Blog" class="md-header__button md-logo" aria-label="Tony's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Tony's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Advanced RAG
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/tlofreso/tlofreso.github.io" title="Go to repository" class="md-source" data-md-component="source" target="_blank" rel="noopener">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Tony&#39;s Blog" class="md-nav__button md-logo" aria-label="Tony's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Tony's Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tlofreso/tlofreso.github.io" title="Go to repository" class="md-source" data-md-component="source" target="_blank" rel="noopener">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Index
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2" >
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Archive
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2024
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_3" >
        
          
          <label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Categories
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Categories
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/boardgames/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Boardgames
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/genai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GenAI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/home-lab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home Lab
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/home-media/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home Media
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/linux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/space/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Space
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#where-to-begin" class="md-nav__link">
    <span class="md-ellipsis">
      
        Where to Begin?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-pitfalls" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Pitfalls
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-five-stages" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Five Stages
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Five Stages">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#loading" class="md-nav__link">
    <span class="md-ellipsis">
      
        Loading
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#indexing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Indexing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Indexing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#text-embedding-3-small" class="md-nav__link">
    <span class="md-ellipsis">
      
        text-embedding-3-small
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text-embedding-3-large" class="md-nav__link">
    <span class="md-ellipsis">
      
        text-embedding-3-large
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text-embedding-ada-002" class="md-nav__link">
    <span class="md-ellipsis">
      
        text-embedding-ada-002
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Storage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#querying" class="md-nav__link">
    <span class="md-ellipsis">
      
        Querying
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluating" class="md-nav__link">
    <span class="md-ellipsis">
      
        Evaluating
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lessons-learned" class="md-nav__link">
    <span class="md-ellipsis">
      
        Lessons Learned
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lessons Learned">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#documents-with-similar-data-are-challenging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Documents with Similar Data are Challenging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embeddings-are-large" class="md-nav__link">
    <span class="md-ellipsis">
      
        Embeddings are Large
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#whats-next" class="md-nav__link">
    <span class="md-ellipsis">
      
        What's next?
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../.." class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
              <div class="md-post__authors md-typeset">
                
                  <div class="md-profile md-post__profile">
                    <span class="md-author md-author--long">
                      <img src="/assets/profile-small.png" alt="Tony Lofreso">
                    </span>
                    <span class="md-profile__description">
                      <strong>
                        
                          Tony Lofreso
                        
                      </strong>
                      <br>
                      Network Engineer
                    </span>
                  </div>
                
              </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2024-05-15 00:00:00+00:00" class="md-ellipsis">May 15, 2024</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../../category/genai/">GenAI</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              11 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  



  
  


<h1 id="advanced-rag">Advanced RAG<a class="headerlink" href="#advanced-rag" title="Permanent link">ðŸ”—&#xFE0E;</a></h1>
<p><em>First things first... This is <ins>not</ins> advanced RAG. But it does mark an evolution in my ability, and feels advanced to 2024 Tony.</em></p>
<p>The other day, I came across <a href="https://twitter.com/llama_index/status/1788686110593368509" target="_blank" rel="noopener">this post</a>. It's a video of <a href="https://en.wikipedia.org/wiki/El_Risitas" target="_blank" rel="noopener">El Risitas</a> guy, and the subtitles (included below) convey all the <em>laughably ridiculous</em> things people writing RAG apps today are doing.<!-- more --></p>
<blockquote>
<p>They split the file into chunks by page, or by paragraph or who the fuck knows. Embed it with <code>ada-002</code> for a couple cents. Store the embeddings in some hacked together database. They match your query by cosine similarity <img alt="ðŸ˜†" class="twemoji" src="../../../../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f606.svg" title=":laughing:"> and return the top k. <img alt="ðŸ¤£" class="twemoji" src="../../../../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f923.svg" title=":rofl:"> If the answer is bad ... they just increase the value of k! <img alt="ðŸ˜†" class="twemoji" src="../../../../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f606.svg" title=":laughing:"> <img alt="ðŸ¤£" class="twemoji" src="../../../../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f923.svg" title=":rofl:"> Users have no idea how embeddings work, so they fill their query full of keywords expecting it to match but the top results are <code>README.md</code> and 5 <code>__init__</code> files so they switch to <code>text-embedding-3-large</code> and get a bigger disk <img alt="ðŸ¤£" class="twemoji" src="../../../../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f923.svg" title=":rofl:"> and performance gets <strong>worse</strong>. Convince their boss to pay for Pinecone, <img alt="ðŸ¤£" class="twemoji" src="../../../../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f923.svg" title=":rofl:"> <img alt="ðŸ¤£" class="twemoji" src="../../../../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f923.svg" title=":rofl:"> <img alt="ðŸ¤£" class="twemoji" src="../../../../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f923.svg" title=":rofl:"> still no beans! Still haven't added a keyword search!</p>
</blockquote>
<p><img alt="el-risitas" src="../../../../assets/posts/advanced-rag/el-risitas.jpeg" /></p>
<p>Derisive tactics aside, having someone tell you how not to do something can help inform better approaches. I had confidently "increased the value of k" and "switched to <code>text-embedding-3-large</code>". Afterall, OpenAI <a href="https://platform.openai.com/docs/assistants/tools/file-search/how-it-works" target="_blank" rel="noopener">says</a> that's a best practice! Lest we forget<img alt="ðŸš©" class="twemoji" src="../../../../assets/external/cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f6a9.svg" title=":triangular_flag_on_post:">... OpenAI will store your embedded data for $0.10/GB. That adds up quick when the default settings are:</p>
<ul>
<li>Model: <code>text-embedding-3-large</code></li>
<li>Chunk Size: <code>800 tokens</code></li>
<li>Chunk Overlap: <code>400 tokens</code></li>
</ul>
<p>With all this as a backdrop, here are some of my musings while learning how to do RAG.</p>
<h2 id="where-to-begin">Where to Begin?<a class="headerlink" href="#where-to-begin" title="Permanent link">ðŸ”—&#xFE0E;</a></h2>
<p>For my use case, I have three goals:</p>
<ol>
<li>Ingest custom data</li>
<li>Return accurate responses to user prompts</li>
<li>Always include a citation in the response</li>
</ol>
<p>I'll be using <a href="https://www.llamaindex.ai/open-source" target="_blank" rel="noopener">LlamaIndex</a>.  </p>
<p>One of the better Getting Started resources I've found is this <a href="https://docs.llamaindex.ai/en/stable/getting_started/concepts/" target="_blank" rel="noopener">High-Level Concepts (RAG)</a> page from the LlamaIndex docs. It covers, in general, the five 'stages' every RAG app will have:</p>
<pre class="mermaid"><code>flowchart LR
    A[Loading] --&gt; B[Indexing] --&gt; C[Storing] --&gt; D[Querying] --&gt; E[Evaluating]</code></pre>
<p>What you quickly discover, is each of these stages may have several steps (pipelines), and configuration varies widely. In the case of Querying, there are generally three sub-stages: Retrieval, Post Processing, and Response Synthesis. If we look at Retrieval, LlamaIndex covers 17 different <a href="https://docs.llamaindex.ai/en/stable/api_reference/retrievers/" target="_blank" rel="noopener">Retrievers</a> in their docs alone. Any of these can be used singularly, or combined for various effects and tactics you may want to employ when RAG-ing your data. Daunting, I know. But at least they've given us a framework to break things down.</p>
<h2 id="common-pitfalls">Common Pitfalls<a class="headerlink" href="#common-pitfalls" title="Permanent link">ðŸ”—&#xFE0E;</a></h2>
<p>There are a few patterns I've noticed that newbies encounter.</p>
<ol>
<li>Users want citations. The first way folks try to accomplish this, is by coaxing the llm to cite the response. "Be sure to include the page where the answer was found." I've found this technique to be wildly inconsistent, and inaccurate.</li>
<li>As your dataset increases... querying, and the steps you perform before that stage get much more complex. Early wins feel really great, but quickly dissolve as soon as you begin to scale.</li>
<li>OpenAI develops really, really fast. The hurdle you solved for this week, may simply not exist next week. This creates a weird dynamic for prioritizing work</li>
</ol>
<h2 id="the-five-stages">The Five Stages<a class="headerlink" href="#the-five-stages" title="Permanent link">ðŸ”—&#xFE0E;</a></h2>
<h3 id="loading">Loading<a class="headerlink" href="#loading" title="Permanent link">ðŸ”—&#xFE0E;</a></h3>
<p>Loading your data is part of the "Ingestion Pipeline" which includes: loading -&gt; transforming -&gt; indexing -&gt; storage. I've been scoping my loading stage to use LlamaIndex's <code>SimpleDirectoryReader</code> because it's straightforward to setup, and is general enough for my use case. Here's how we can load some data:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">llama_index.core</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">SimpleDirectoryReader</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stage 1: Load Data&quot;&quot;&quot;</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">SimpleDirectoryReader</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">documents</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">load</span><span class="p">())</span>
</code></pre></div>
<p>My data consists of rule books from GMT war games; <a href="https://www.gmtgames.com/living_rules/TS_Rules_Deluxe.pdf" target="_blank" rel="noopener">Twilight Struggle</a>, <a href="https://www.gmtgames.com/churchill/CHURCHILLRules-Final.pdf" target="_blank" rel="noopener">Churchill</a>, and <a href="https://www.gmtgames.com/nnfp/FTP-rules-2014.pdf" target="_blank" rel="noopener">For the People</a>. The data returned from <code>SimpleDirectoryReader</code> is a list of "Documents".</p>
<div class="admonition note">
<p class="admonition-title">LlamaIndex definition of a Document</p>
<p>A Document is a generic container around any data source - for instance, a PDF, an API output, or retrieved data from a database. They can be constructed manually, or created automatically via our data loaders.</p>
</div>
<p>In our case, the load stage returned a list of 116 documents which happens to equal the total pages for all three rule books. This must be how LlamaIndex handles PDFs when using the <code>SimpleDirectoryReader</code>.</p>
<div class="highlight"><span class="filename">Content of a LlamaIndex document</span><pre><span></span><code><span class="n">Document</span><span class="p">(</span>
        <span class="n">id_</span><span class="o">=</span><span class="s1">&#39;c7adc363-32e7-42b3-99fe-b356cd2f0be7&#39;</span><span class="p">,</span>
        <span class="n">embedding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;page_label&#39;</span><span class="p">:</span> <span class="s1">&#39;22&#39;</span><span class="p">,</span> <span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="s1">&#39;CHURCHILLRules-Final.pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;file_path&#39;</span><span class="p">:</span> <span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">projects</span><span class="se">\\</span><span class="s1">learn-llama-index</span><span class="se">\\</span><span class="s1">advanced-rag</span><span class="se">\\</span><span class="s1">data</span><span class="se">\\</span><span class="s1">CHURCHILLRules-Final.pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;file_type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;file_size&#39;</span><span class="p">:</span> <span class="mi">2051633</span><span class="p">,</span> <span class="s1">&#39;creation_date&#39;</span><span class="p">:</span> <span class="s1">&#39;2024-05-12&#39;</span><span class="p">,</span> <span class="s1">&#39;last_modified_date&#39;</span><span class="p">:</span> <span class="s1">&#39;2024-05-12&#39;</span><span class="p">},</span>
        <span class="n">excluded_embed_metadata_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;file_type&#39;</span><span class="p">,</span> <span class="s1">&#39;file_size&#39;</span><span class="p">,</span> <span class="s1">&#39;creation_date&#39;</span><span class="p">,</span> <span class="s1">&#39;last_modified_date&#39;</span><span class="p">,</span> <span class="s1">&#39;last_accessed_date&#39;</span><span class="p">],</span>
        <span class="n">excluded_llm_metadata_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;file_type&#39;</span><span class="p">,</span> <span class="s1">&#39;file_size&#39;</span><span class="p">,</span> <span class="s1">&#39;creation_date&#39;</span><span class="p">,</span> <span class="s1">&#39;last_modified_date&#39;</span><span class="p">,</span> <span class="s1">&#39;last_accessed_date&#39;</span><span class="p">],</span>
        <span class="n">relationships</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Churchill Rules22</span><span class="se">\n</span><span class="s1">Â© 2015 GMT Games, LLC</span><span class="se">\n</span><span class="s1">10.0 Secret Agenda Variant </span><span class="se">\n</span><span class="s1">DESIGN NOTE: I have found gamers of two minds on games </span><span class="se">\n</span><span class="s1">with continuous scoring like Churchill. Some folks like know-ing the exact score at all times and manage their decisions based on perfect â€˜scoreâ€™ information, whileothers like a bit more uncertainty. The core game uses perfect scoring but for those who like to have a bit more bluff in their games I offer the following official variant.</span><span class="se">\n</span><span class="s1">10.1 Secret Agenda Markers</span><span class="se">\n</span><span class="s1"> â€˜Secret Agendaâ€™ markers are marked as such and also have the name of a country or colony on one side. Note that there are some duplicates for some countries/colonies; this is intentional and these are not extras.</span><span class="se">\n</span><span class="s1">10.2 Secret Agenda Procedure</span><span class="se">\n</span><span class="s1">Take the 36 Secret Agenda markers; each player secretly and randomly draws three markers. Do not show them to your op-ponents. At the end of the game before you determine the winner, all players reveal their Secret Agenda markers.10.3 Secret Agenda Scoring</span><span class="se">\n</span><span class="s1">If at the end of the game a player has a Political Alignment marker in a country/colony that matches one of their Secret Agenda markers they score five additional points per marker, for a potential of 15 points if all three markers meet this condition. After these points have been applied to each players score the winner is determined.</span><span class="se">\n</span><span class="s1">PLAY NOTE: It is possible and intentional that the application of the Secret Agenda marker bonus could impact the condition under which the winner is determined, i.e.,    creates a 15 point difference in score that can change the winner. This fact needs to be incorporated into a playerâ€™ s strategy, so be careful how hard you fight for your Secret Agenda.</span><span class="se">\n</span><span class="s1">PLAY NOTE: You score 5 VP per Secret Agenda marker, so if you have two markers for the same location, you would score 10 VP .</span><span class="se">\n</span><span class="s1">Stalin and Churchill enjoy a private moment during the Yalta Conference.&#39;</span><span class="p">,</span>
        <span class="n">start_char_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">end_char_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">text_template</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{metadata_str}</span><span class="se">\n\n</span><span class="si">{content}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">metadata_template</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{key}</span><span class="s1">: </span><span class="si">{value}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">metadata_seperator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="p">)</span>
</code></pre></div>
<p>The metadata returned here is pretty handy. My hope is that I'll be able to use this to accurately cite answers later.</p>
<h3 id="indexing">Indexing<a class="headerlink" href="#indexing" title="Permanent link">ðŸ”—&#xFE0E;</a></h3>
<p>Indexing typically involves generating embeddings. An <a href="https://platform.openai.com/docs/guides/embeddings/what-are-embeddings" target="_blank" rel="noopener">Embedding</a> "is a vector (list) of floating point numbers. The distance between two vectors measures their relatedness." Send text in, get a load of floats back. Here's an example.  </p>
<p><em>Note. I reduced the <code>dimensions</code> significantly to 30. By default, thousands of floats would be returned.</em>
<div class="highlight"><pre><span></span><code>tlofreso@MacBook-Pro:~$<span class="w"> </span>curl<span class="w"> </span>https://api.openai.com/v1/embeddings<span class="w"> </span><span class="se">\</span>
&gt;<span class="w">   </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
&gt;<span class="w">   </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer </span><span class="nv">$OPENAI_API_KEY</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
&gt;<span class="w">   </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">&gt;     &quot;input&quot;: &quot;Once more unto the breach, dear friends, once more&quot;,</span>
<span class="s1">&gt;     &quot;model&quot;: &quot;text-embedding-3-small&quot;,</span>
<span class="s1">&gt;     &quot;dimensions&quot;: 30</span>
<span class="s1">&gt;   }&#39;</span>
<span class="o">{</span>
<span class="w">  </span><span class="s2">&quot;object&quot;</span>:<span class="w"> </span><span class="s2">&quot;list&quot;</span>,
<span class="w">  </span><span class="s2">&quot;data&quot;</span>:<span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="o">{</span>
<span class="w">      </span><span class="s2">&quot;object&quot;</span>:<span class="w"> </span><span class="s2">&quot;embedding&quot;</span>,
<span class="w">      </span><span class="s2">&quot;index&quot;</span>:<span class="w"> </span><span class="m">0</span>,
<span class="w">      </span><span class="s2">&quot;embedding&quot;</span>:<span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="m">0</span>.14859965,
<span class="w">        </span><span class="m">0</span>.25593004,
<span class="w">        </span><span class="m">0</span>.1891131,
<span class="w">        </span><span class="m">0</span>.10665011,
<span class="w">        </span><span class="m">0</span>.08737599,
<span class="w">        </span><span class="m">0</span>.0665146,
<span class="w">        </span><span class="m">0</span>.016647546,
<span class="w">        </span><span class="m">0</span>.15918152,
<span class="w">        </span>-0.25834873,
<span class="w">        </span>-0.018678887,
<span class="w">        </span><span class="m">0</span>.20302069,
<span class="w">        </span>-0.23854554,
<span class="w">        </span>-0.12834294,
<span class="w">        </span>-0.18593854,
<span class="w">        </span><span class="m">0</span>.21073033,
<span class="w">        </span><span class="m">0</span>.09992307,
<span class="w">        </span>-0.20029964,
<span class="w">        </span><span class="m">0</span>.08027103,
<span class="w">        </span>-0.13333154,
<span class="w">        </span><span class="m">0</span>.2108815,
<span class="w">        </span>-0.23340577,
<span class="w">        </span><span class="m">0</span>.13514556,
<span class="w">        </span><span class="m">0</span>.123429924,
<span class="w">        </span><span class="m">0</span>.012348661,
<span class="w">        </span>-0.26983762,
<span class="w">        </span><span class="m">0</span>.1795894,
<span class="w">        </span>-0.10135917,
<span class="w">        </span>-0.0073128263,
<span class="w">        </span><span class="m">0</span>.48374254,
<span class="w">        </span>-0.10302204
<span class="w">      </span><span class="o">]</span>
<span class="w">    </span><span class="o">}</span>
<span class="w">  </span><span class="o">]</span>,
<span class="w">  </span><span class="s2">&quot;model&quot;</span>:<span class="w"> </span><span class="s2">&quot;text-embedding-3-small&quot;</span>,
<span class="w">  </span><span class="s2">&quot;usage&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;prompt_tokens&quot;</span>:<span class="w"> </span><span class="m">11</span>,
<span class="w">    </span><span class="s2">&quot;total_tokens&quot;</span>:<span class="w"> </span><span class="m">11</span>
<span class="w">  </span><span class="o">}</span>
<span class="o">}</span>
tlofreso@MacBook-Pro:~$<span class="w"> </span>
</code></pre></div></p>
<p>By default LlamaIndex will use the <code>text-embedding-ada-002</code> model for embedding. I switched the embedding model to the new <code>text-embedding-3-small</code> because it's <a href="https://platform.openai.com/docs/guides/embeddings/embedding-models" target="_blank" rel="noopener">more capable</a>, and 1/5th of the price. Changing the default chunk size, and overlap has a significant effect on the embeddings. OpenAI is using the <code>text-embedding-3-large</code> model, with chunk sizes of 800 and 50% overlap. While <code>text-embedding-3-large</code> is a more capable model, it takes up significantly more disk. For three files totaling <code>7.04mb</code> this is what you'll end up with for the various models and chunk configurations:</p>
<h4 id="text-embedding-3-small">text-embedding-3-small<a class="headerlink" href="#text-embedding-3-small" title="Permanent link">ðŸ”—&#xFE0E;</a></h4>
<div class="highlight"><pre><span></span><code>Default settings:                   5 files - 7.75mb
chunk_size=1000, chunk_overlap=200: 5 files - 9.55mb
chunk_size=800, chunk_overlap=400:  5 files - 11.5mb
chunk_size=200, chunk_overlap=100:  5 files - 64.9mb
</code></pre></div>
<h4 id="text-embedding-3-large">text-embedding-3-large<a class="headerlink" href="#text-embedding-3-large" title="Permanent link">ðŸ”—&#xFE0E;</a></h4>
<div class="highlight"><pre><span></span><code>Default settings:                   5 files - 14.3mb
chunk_size=1000, chunk_overlap=200: 5 files - 17.9mb
chunk_size=800, chunk_overlap=400:  5 files - 21.5mb
chunk_size=200, chunk_overlap=100:  5 files - 124mb
</code></pre></div>
<h4 id="text-embedding-ada-002">text-embedding-ada-002<a class="headerlink" href="#text-embedding-ada-002" title="Permanent link">ðŸ”—&#xFE0E;</a></h4>
<div class="highlight"><pre><span></span><code>Default settings:                   5 files - 7.78mb
chunk_size=1000, chunk_overlap=200: 5 files - 9.61mb
chunk_size=800, chunk_overlap=400:  5 files - 11.6mb
chunk_size=200, chunk_overlap=100:  5 files - 65.3mb
</code></pre></div>
<p>Here are the settings I ended up having the most success with:
<div class="highlight"><pre><span></span><code><span class="n">Settings</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">)</span>
<span class="n">Settings</span><span class="o">.</span><span class="n">embed_model</span> <span class="o">=</span> <span class="n">OpenAIEmbedding</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;text-embedding-3-small&quot;</span><span class="p">)</span>
<span class="n">Settings</span><span class="o">.</span><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">SentenceSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="storage">Storage<a class="headerlink" href="#storage" title="Permanent link">ðŸ”—&#xFE0E;</a></h3>
<p>For now, we're keeping storage simple. Right on the local filesystem. The code below will...</p>
<ol>
<li>Set the llm, embedding, and chunk config</li>
<li>Load the data</li>
<li>Generate the embeddings</li>
<li>Store those embeddings on the filesystem</li>
<li>Checks for existing embeddings, creates them if missing</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">llama_index.core</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">Settings</span><span class="p">,</span> <span class="n">SimpleDirectoryReader</span><span class="p">,</span> <span class="n">VectorStoreIndex</span><span class="p">,</span> <span class="n">StorageContext</span><span class="p">)</span>

<span class="n">Settings</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">)</span>
<span class="n">Settings</span><span class="o">.</span><span class="n">embed_model</span> <span class="o">=</span> <span class="n">OpenAIEmbedding</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;text-embedding-3-small&quot;</span><span class="p">)</span>
<span class="n">Settings</span><span class="o">.</span><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">SentenceSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">PERSIST_DIR</span> <span class="o">=</span> <span class="s2">&quot;./storage&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stage 1: Load Data&quot;&quot;&quot;</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">SimpleDirectoryReader</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">documents</span>

<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">(</span><span class="n">documents</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stage 2: Index Data&quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">VectorStoreIndex</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">index</span><span class="o">.</span><span class="n">storage_context</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">persist_dir</span><span class="o">=</span><span class="n">PERSIST_DIR</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1"># See if the index has been created, and create it if it hasn&#39;t</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">PERSIST_DIR</span><span class="p">):</span>
        <span class="n">index</span><span class="p">(</span><span class="n">load</span><span class="p">())</span>
</code></pre></div>
<h3 id="querying">Querying<a class="headerlink" href="#querying" title="Permanent link">ðŸ”—&#xFE0E;</a></h3>
<p>I have a lot to learn about querying. For the purposes of the goals outlined above, I was able to simply pass the index we're storing to a <code>query_engine</code> and the performance was pretty good.</p>
<div class="highlight"><pre><span></span><code><span class="n">storage_context</span> <span class="o">=</span> <span class="n">StorageContext</span><span class="o">.</span><span class="n">from_defaults</span><span class="p">(</span><span class="n">persist_dir</span><span class="o">=</span><span class="n">PERSIST_DIR</span><span class="p">)</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">load_index_from_storage</span><span class="p">(</span><span class="n">storage_context</span><span class="p">)</span>
<span class="n">query_engine</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">as_query_engine</span><span class="p">()</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">query_engine</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;How does Stalin&#39;s &#39;niet&#39; ability work?&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>------------------------

Prompt:<span class="w"> </span>How<span class="w"> </span>does<span class="w"> </span>Stalin<span class="s1">&#39;s &#39;</span>niet<span class="s1">&#39; ability work?</span>

<span class="s1">Answer: Stalin&#39;</span>s<span class="w"> </span><span class="s1">&#39;nyet&#39;</span><span class="w"> </span>ability<span class="w"> </span>allows<span class="w"> </span>him<span class="w"> </span>to<span class="w"> </span>add<span class="w"> </span>a<span class="w"> </span>value<span class="w"> </span>of<span class="w"> </span>+1<span class="w"> </span>when<span class="w"> </span>debating<span class="w"> </span>issues,<span class="w"> </span>reflecting<span class="w"> </span>his<span class="w"> </span>strong<span class="w"> </span>opposition<span class="w"> </span>and<span class="w"> </span>influence.<span class="w"> </span>This<span class="w"> </span>characteristic<span class="w"> </span>is<span class="w"> </span>used<span class="w"> </span>to<span class="w"> </span>move<span class="w"> </span>issues<span class="w"> </span>more<span class="w"> </span>effectively<span class="w"> </span>during
discussions.

Citation:<span class="w"> </span>CHURCHILLRules-Final.pdf<span class="w"> </span>-<span class="w"> </span>page<span class="w"> </span><span class="m">28</span>
Citation:<span class="w"> </span>CHURCHILLRules-Final.pdf<span class="w"> </span>-<span class="w"> </span>page<span class="w"> </span><span class="m">29</span>

------------------------
</code></pre></div>
<p>Nice! It works!  </p>
<p>I don't show it here... but LlamaIndex includes in the response <code>text</code> word for word from the document. This is great because we can give the user a verbatim excerpt from the document they're inquiring about.</p>
<h3 id="evaluating">Evaluating<a class="headerlink" href="#evaluating" title="Permanent link">ðŸ”—&#xFE0E;</a></h3>
<p>This is a stage for another day. Probably a future post once I get around to it :)</p>
<h2 id="lessons-learned">Lessons Learned<a class="headerlink" href="#lessons-learned" title="Permanent link">ðŸ”—&#xFE0E;</a></h2>
<h3 id="documents-with-similar-data-are-challenging">Documents with Similar Data are Challenging<a class="headerlink" href="#documents-with-similar-data-are-challenging" title="Permanent link">ðŸ”—&#xFE0E;</a></h3>
<p>When dealing with documents that contains similar, but different data... it can be challenging to get relevant results. As an example, The Harmonie Group publishes law guides that provide insights on various legal topics at a state level. If you were to ingest the following files:</p>
<div class="highlight"><pre><span></span><code>Ohio Harmonie Law Guide.pdf
Arizona Harmonie Law Guide.pdf
Illinois Harmonie Law Guide.pdf
Delaware Harmonie Law Guide.pdf
Washington Harmonie Law Guide.pdf
Pennsylvania Harmonie Law Guide.pdf
</code></pre></div>
<p>And then write a prompt that says "What is the statute of limitations in Ohio?" the LLM will give you a summary of the statute of limitations laws, but it may not be for Ohio. If I upload 50 law guides, all of which contain statutes of limitation, things get muddy quickly with the returned responses. This is why citing the data is so important.</p>
<p>Altering the <code>chunk_size</code> and <code>chunk_overlap</code> seemed to help solve this quite a bit. Post-processing in Python can help as well, simply removing responses that aren't relevant</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;State mismatch in response for </span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">source_nodes</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">]</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;page_label&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> - page </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s2"> in Filename? </span><span class="si">{</span><span class="n">state</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Here's an article I came across that touches briefly on similar, but different data challenges: <a href="https://www.eyelevel.ai/post/most-accurate-rag" target="_blank" rel="noopener">World's Most Accurate RAG?</a></p>
<blockquote>
<p>Cosine similarity is a popular strategy, but it has a big limitation; itâ€™s often tripped up by semantic similarity. Basically, cosine similarity can get confused if there are superficial similarities in two pieces of text. Because many of the documents contain information about tax information, itâ€™s likely that LangChain and LlamaIndex both got confused and simply returned a chunk which was irrelevant to the prompt.</p>
</blockquote>
<h3 id="embeddings-are-large">Embeddings are Large<a class="headerlink" href="#embeddings-are-large" title="Permanent link">ðŸ”—&#xFE0E;</a></h3>
<p>I was surprised when I matched my application's config to OpenAI's <code>chunk_size=800, chunk_overlap=400</code>, and the files I uploaded for embedding, returned 3x in size. In hindsight, they're reducing the dimensions as well, so it's likely not a 3-fold increase, but still something that needs considered.</p>
<p>It's clear to me that enterprise RAG won't be as simple as embedding the entire network share. Some thought will go into whether something is embedded, and stored to disk... or embedded in memory on demand.</p>
<h2 id="whats-next">What's next?<a class="headerlink" href="#whats-next" title="Permanent link">ðŸ”—&#xFE0E;</a></h2>
<p>I'm fairly motivated by the progress I've made. These are the things I want to work on next:</p>
<ul>
<li>Adding a frontend to my RAG app. There are many, I'll probably start with streamlit, flask, librechat, or openwebui.</li>
<li>I'd like to learn more about data lifecycle management. Best practices for updating the embeddings of a newly modified file. Removing old embeddings, adding new files, etc.</li>
<li>At some point I'll need to get embeddings into a proper database vs json files on my filesystem.</li>
<li>Ingest data from additional sources</li>
<li>Dive deeper on querying</li>
<li>Figure an elegant way to evaluate output</li>
</ul>
<p>There's a lot to learn. It's overwhelming, but there are enough wins along the way that I'm able to stay excited about the work.</p>







  
  




  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../../03/15/my-plans-for-the-2024-solar-eclipse/" class="md-footer__link md-footer__link--prev" aria-label="Previous: My Plans for the 2024 Solar Eclipse">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                My Plans for the 2024 Solar Eclipse
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../08/19/i-napoleon/" class="md-footer__link md-footer__link--next" aria-label="Next: I, Napoleon">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                I, Napoleon
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs Insiders
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://x.com/tlofreso" target="_blank" rel="noopener" title="x.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/tlofreso" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["content.code.copy", "content.footnote.tooltips", "navigation.footer", "navigation.instant", "navigation.sections", "navigation.instant.progress", "navigation.instant.prefetch"], "search": "../../../../assets/javascripts/workers/search.ad38c271.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.1a6dba85.min.js"></script>
      
    
  </body>
</html>